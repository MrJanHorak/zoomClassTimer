<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Break Timer</title>
  </head>
  <body>
    <h1 class="time">Current Time: <span id="current-time">00:00</span></h1>

    <h1 class="time">Break Until: <span id="break-until">00:00</span></h1>

    <div id="timer">
      <h1 id="time">00:00</h1>
    </div>
    <div class="setting-contatiner">
      <label for="show-setting"
        >Show settings
        <input type="checkbox" name="show-setting" id="show-setting" />
      </label>
      <div class="setting">
        <label for="break-until-time"
          >Break Until
          <input type="time" name="break-until-time" id="break-until-time" />
        </label>
        <label for="break-time"
          >Break Time (minutes)
          <input type="number" name="break-time" id="break-time" value="5"
        /></label>
        <div class="preset-minutes">
          <button class="minute-choice" type="button">5</button>
          <button class="minute-choice" type="button">10</button>
          <button class="minute-choice" type="button">15</button>
          <button class="minute-choice" type="button">20</button>
          <button class="minute-choice" type="button">25</button>
          <button class="minute-choice" type="button">30</button>
        </div>
        <div class="button-container">
          <button id="start">Start</button>
          <button id="pause">Pause</button>
          <button id="reset">Reset</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #timer {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3rem;
    }

    .setting {
      display: none;
      flex-direction: column;
      align-items: center;
      align-content: center;
    }

    .setting-contatiner {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .time {
      font-size: 1.5rem;
    }
  </style>
  <script>
    const setting = document.querySelector('.setting');
    const timer = document.getElementById('time');
    const start = document.getElementById('start');
    const pause = document.getElementById('pause');
    const reset = document.getElementById('reset');
    // const breakLeft = document.getElementById('break-left');
    const breakUntilTime = document.getElementById('break-until-time');
    const breakUntilDisplay = document.getElementById('break-until');
    const breakTimeInput = document.getElementById('break-time');
    const minuteChoices = document.querySelectorAll('.minute-choice');
    let progress = 0;
    let initialTime = 0;
    let time = 0;
    let interval;

    function updateTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const currentTime = `${hours}:${minutes}:${seconds}`;
      document.getElementById('current-time').textContent = currentTime;
    }

    setInterval(updateTime, 1000);
    window.onload = updateTime;

    function createProgressSVG(progress, color) {
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="14" stroke="#999" stroke-width="6" fill="none" />
          <circle cx="16" cy="16" r="14" stroke="${color}" stroke-width="6" fill="none" stroke-dasharray="${
        progress * 100
      }, 100" transform="rotate(-90 16 16)" />
      </svg>`;
      return `data:image/svg+xml,${encodeURIComponent(svg)}`;
    }

    function setFavicon(url) {
      console.log('favicon url', url);
      const link =
        document.querySelector("link[rel*='icon']") ||
        document.createElement('link');
      link.type = 'image/x-icon';
      link.rel = 'shortcut icon';
      link.href = url;
      document.getElementsByTagName('head')[0].appendChild(link);
    }

    function updateFavicon() {
      const progress = (initialTime - time) / initialTime;
      const color = progress > 0.5 ?  '#FF0000': '#00FF00'; 
      const faviconURL = createProgressSVG(progress, color);
      setFavicon(faviconURL);
    }

    function updateBreakTime() {
      const minutes = Math.floor(time / 60);
      const seconds = time % 60;
      timer.innerHTML = `${String(minutes).padStart(2, '0')}:${String(
        seconds
      ).padStart(2, '0')}`;
      document.title =
        'Break timer - ' +
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(
          2,
          '0'
        )}`;
      // breakLeft.innerHTML = timer.innerHTML;
      updateFavicon();
    }

    start.addEventListener('click', () => {
      clearInterval(interval);
      interval = setInterval(() => {
        if (time > 0) {
          time--;
          updateBreakTime();
        } else {
          clearInterval(interval);
        }
      }, 1000);
    });

    pause.addEventListener('click', () => {
      clearInterval(interval);
    });

    reset.addEventListener('click', () => {
      clearInterval(interval);
      time = 0;
      timer.innerHTML = '00:00';
      // breakLeft.innerHTML = '00:00';
      breakUntilDisplay.innerHTML = '00:00';
    });

    document.getElementById('show-setting').addEventListener('change', (e) => {
      setting.style.display = e.target.checked ? 'flex' : 'none';
    });

    breakTimeInput.addEventListener('change', (e) => {
      time = e.target.value * 60;
      initialTime = time;
      updateBreakTime();
      const now = new Date();
      const breakUntil = new Date(now.getTime() + time * 1000);
      const hours = String(breakUntil.getHours()).padStart(2, '0');
      const minutes = String(breakUntil.getMinutes()).padStart(2, '0');
      breakUntilDisplay.innerHTML = `${hours}:${minutes}`;
    });

    breakUntilTime.addEventListener('change', (e) => {
      const [hours, minutes] = e.target.value.split(':');
      const now = new Date();
      const breakUntil = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        hours,
        minutes
      );
      const diff = breakUntil - now;
      time = Math.floor(diff / 1000);
      updateBreakTime();
      breakUntilDisplay.innerHTML = e.target.value;
      document.title = 'Break Timer - ' + value;
    });

    addEventListener('click', (e) => {
      if (e.target.classList.contains('minute-choice')) {
        breakTimeInput.value = e.target.textContent;
        breakTimeInput.dispatchEvent(new Event('change'));
      }
    });
  </script>
</html>
